.card.card-outline.card-primary
  .card-header
    .card-title
      %i.fas.fa-map-marker-alt
      #{EvalMovement.model_name.human(count: 2)}: 
      %span#places_count= @places.count
      \- day: #{@day}
  .card-body
    #map_movements{ style: "height: 880px;" }
:javascript
  function getMovements(bbox) {
    $.ajax({
      url: '/data_analysis/maps.json?bbox=' + bbox,
      success: function(data) {
        setCluster(data)
        $('span#places_count').html(data.features.length)
      }
    });
  }

  function setBbox() {
    const bounds = map.getBounds();
    bbox = bounds._southWest.lng + ',' + bounds._southWest.lat + ',' + bounds._northEast.lng + ',' + bounds._northEast.lat;
    getMovements(bbox)
  }

  function compilePopup(properties) {
    str = '<h3>' + properties.customer_full_name + '</h3>'
    str += '<h5>' + properties.beneficiary + '</h5>'
    str += '<p>' 
    str += properties.beneficiary_iban + '<br />'
    str += properties.address + '<br />'
    str += (properties.amount.cents / 100).toLocaleString("en-US", {style:"currency", currency:"EUR"}); + '<br />'
    str += '</p>'
    return str
  }

  function setCluster(geoJsonData) {
    if (markers) {
      map.removeLayer(markers);
    }
    var geoJsonLayer = L.geoJson(geoJsonData, {
      onEachFeature: function (feature, layer) {
        str = compilePopup(feature.properties)
        layer.bindPopup(str);
      }
    });
    markers = L.markerClusterGroup();
    markers.addLayer(geoJsonLayer);
    map.addLayer(markers);
  }
  
  var markers = L.markerClusterGroup();

  function initMap() {
    coords = [35.9480742, 14.3973929]
    map = new L.map('map_movements');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      minZoom: 3,
      attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    }).addTo(map);
    map.setView(new L.LatLng(coords[0], coords[1]), 5);
    map.on('zoomend', function() {
      setBbox();
    });
    map.on('dragend', function() {
      setBbox();
    });
    setBbox();
  }
  var bbox;
  var map;
  initMap();
  setBbox()
